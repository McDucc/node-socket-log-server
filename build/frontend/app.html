<html>

<head>
    <script defer src="/alpine.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/translation.js"></script>
    <link rel="stylesheet" href="/bootstrap.css">
    <link rel="stylesheet" href="/style.css">
    </link>
</head>

<body x-data class="body-base">
    <div class="modal-overlay" x-show="$store.controls.showModal"></div>
    <div class="modalx bd-example" x-show="$store.controls.showModal">

        <p class="mt-2">Password: </p>
        <input class="form-control" type="text" x-model="$store.credentials.password"
            @keydown.enter="$store.controls.showModal = false; authenticate();">
        <div class=" mt-4">
            <button class="btn btn-primary" @click=" $store.controls.showModal=false; authenticate();">Close</button>
        </div>
    </div>
    <div class="col-md-11 mt-3" style="margin: auto; "><a class="title-x" style="color: #0d5dd6;">Socket</a><a
            class="title-x">Logger</a>
        <div class="bd-example row col-md-12 mt-4" style="margin: auto;">
            <div class="row mt-2">
                <div class="col-md-12">
                    <button class="alert btn btn-primary float-start"
                        x-on:click="$store.controls.showModal = true;">Authenticate
                    </button>

                    <button class="alert btn btn-primary float-end"
                        x-on:click="$store.controls.showServerMetrics ^= true"
                        x-text="$store.controls.showServerMetrics ? 'Switch to messages' : 'Switch to metrics'">
                    </button>
                    <div class="alert alert-danger ms-4 float-start" x-show="$store.credentials.authenticated == 1">
                        Supplied
                        credentials seem to be incorrect.
                    </div>
                    <div class="alert alert-dark ms-4 alm float-start" x-show="$store.credentials.authenticated == 2">
                        Authenticated successfully.</div>
                </div>
            </div>
            <div class=" row mt-2">
                <div class="col-md-3">
                    <p>Search Term:</p>
                    <input class="form-control" type="text" x-model="$store.controls.searchTerm">
                    <button class="btn btn-primary form-control mt-2"
                        x-bind:disabled="!!$store.controls.autoUpdate">Search</button>
                </div>
                <div class="col-md-3">
                    <p x-text="translate('update_speed')"></p>
                    <select class="form-control mt-2">
                        <template x-for="val in [3,5,10,15,30,60]">
                            <option x-text="val + translate('seconds')" :value="val"></option>
                        </template>
                    </select>
                    <button class="btn btn-primary form-control mt-2" x-on:click="$store.controls.autoUpdate ^= true"
                        x-text="$store.controls.autoUpdate ? translate('auto_update_active') : translate('auto_update_deactivated')"></button>
                </div>
                <div class="col-md-3">
                    <p>Timeframe-Type:</p>
                    <select x-model="$store.controls.timeframeType" class="form-control mt-2">
                        <option value="since" selected>Messages since</option>
                        <option value="timeframe">Messages within Timeframe</option>
                    </select>
                    <div x-show="$store.controls.timeframeType == 'since'">
                        <select class="form-control mt-2" x-model="$store.controls.timeSelect">
                            <template x-for="val in [5,10,15,30,60]">
                                <option x-text="val + translate('minutes')" :value="val"></option>
                            </template>
                            <template x-for="val in [2,4,8,24,48]">
                                <option x-text="val + translate('hours')" :value="val*60"></option>
                            </template>
                            <option x-text="translate('all_time')" value="999999"></option>
                        </select>
                    </div>
                    <div x-show="$store.controls.timeframeType == 'timeframe'">
                        <input class="form-control mt-1" type="datetime-local" x-model="$store.controls.datetime1">
                        <input class="form-control mt-1" type="datetime-local" x-model="$store.controls.datetime2">
                    </div>
                </div>
                <div class="col-md-3">
                    <p>Filter by Server:</p>
                    <select class="form-control mt-2" multiple>
                        <template x-for="server in $store.log.servers">
                            <option x-bind:value="server" x-text="server"></option>
                        </template>
                    </select>
                </div>
            </div>
        </div>
        <div class="bd-example row col-md-12 mt-4" style="margin: auto; font-size: 15px; font-family: monospace;"
            x-show="$store.controls.showServerMetrics">
            <template x-for="server in $store.log.servers">
                <div class="bd-example col-md-12 mt-2">
                    <div x-text="server.name" style="text-align: center;"></div>
                    <template x-for="metric in $store.controls.metrics">
                        <div style="padding: 5px;" class="col-md-3 float-start">
                            <canvas class="metric-canvas" :id="server.name + ': ' + metric"></canvas>
                        </div>
                    </template>
                </div>
            </template>
        </div>
        <div class="bd-example row col-md-12 mt-4" style="margin: auto; font-size: 15px; font-family: monospace;"
            x-show="!$store.controls.showServerMetrics">
            <div class="btn btn-primary alx">
                &lt;
            </div>
            <div class="btn btn-primary alx">
                1
            </div>
            <div class="btn btn-primary alx">
                ...
            </div>
            <div class="btn btn-primary alx">
                12
            </div>
            <div class="btn btn-primary alx">
                ...
            </div>
            <div class="btn btn-primary alx">
                23
            </div>
            <div class="btn btn-primary alx">
                &gt;
            </div>
            <div class="alert alert-dark alm">
                <b>Datetime:</b> 2021-08-01 00:00:00.333<br>
                <b>Message:</b> Example Message Example Message<br>
                <b>Level:</b> Info<br>
                <b>Server:</b> Server 4<br>
                <b>Data:</b><br> Example Message Example Message<br>
            </div>
            <div class="alert alert-danger">
                <b>Datetime:</b> 2021-08-01 00:00:00.333<br>
                <b>Message:</b> Example Message Example Message<br>
                <b>Level:</b> Critical<br>
                <b>Server:</b> Server 4<br>
                <b>Data:</b><br> Example Message Example Message<br>
            </div>
        </div>
    </div>
    <script>
        let basicPost = () => {
            return {
                method: 'POST',
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                headers: {
                    'auth-token': Alpine.store('credentials').password
                }
            };
        }

        async function authenticate() {
            let response = await fetch('/auth', basicPost());
            Alpine.store('credentials').authenticated = await response.text() === 'Authenticated' ? 2 : 1;
        }

        async function updateServerList() {
            let response = await fetch('/servers', basicPost());
            let json = await response.json();
            Alpine.store('log').servers = json.data;
        }

        const millisecondToMinute = 60000.0;
        const cpu_load = 'cpu_load';
        const ram_used = 'ram_used';
        const disk_read = 'disk_read_iops';
        const disk_write = 'disk_write_iops';
        const disk_wait = 'disk_wait_percent';
        const disk_used = 'disk_used';
        const traffic_in = 'traffic_in_kb';
        const traffic_out = 'traffic_out_kb';

        function getTimestamps(timestamp) {
            if (timestamp == 0)
                return Alpine.store('controls').timeframeType == 'since' ? Alpine.store('controls').timeSelect : (Date.now() - new Date(Alpine.store('controls').datetime1).getTime()) / millisecondToMinute;
            else
                return Alpine.store('controls').timeframeType == 'since' ? 0 : (Date.now() - new Date(Alpine.store('controls').datetime2).getTime()) / millisecondToMinute;
        }

        async function updateMetrics() {
            let data = basicPost();
            data.body = {
                parameters: {
                    searchTerms: ['channel: "metrics"'],
                    intervalStart: getTimestamps(0),
                    intervalEnd: getTimestamps(1),
                    pageSize: 20000,
                    page: 0,
                    minimumSeverity: 0,
                    maximumSeverity: 0,
                    servers: Alpine.store('log').servers
                }
            };
            let response = await fetch('/search', data);
            let json = await response.json();
            let resolution = 20;
            if (Array.isArray(json.data)) {
                metricsCompiled = {};
                let totalCounts = {};
                let totalValues = {};
                json.data.forEach(element => {

                });

                Object.keys(counts).forEach((server, index) => {
                    Object.keys(server).forEach((key, index) => {
                        metricsCompiled[server][key] = totalValues[server][key] / totalCounts[server][key];
                    });
                });
            }
        }

        setInterval(() => {
            if (Alpine.store('credentials').authenticated === 2)
                try {
                    await updateServerList();
                    await updateMetrics();
                } catch (err) {
                    console.log(err)
                }
        }, 5000);

        document.addEventListener('alpine:init', () => {

            Alpine.store('log', {
                servers: [],
                messages: [],
                metricsCompiled: {}
            })

            Alpine.store('controls', {
                datetime1: new Date().toISOString().split('.')[0],
                datetime2: new Date().toISOString().split('.')[0],
                timeSelect: '2',
                showModal: true,
                showServerMetrics: false,
                autoUpdate: false,
                metrics: [cpu_load, ram_used, disk_read, disk_write, disk_wait, disk_used, traffic_in, traffic_out],
                timeframeType: 'since',
                currentPage: 0,
                searchTerm: '',
            })

            Alpine.store('credentials', {
                password: '',
                authenticated: 0
            })

            this.translate = initializeTranslation(Alpine);
        });

        function search(searchTerm, minimumSeverity, maximumSeverity, page, pageSize) {
            let data = basicPost();

            data.body = {
                parameters: {
                    searchTerms: [searchTerm],
                    intervalStart: getTimestamps(0),
                    intervalEnd: getTimestamps(1),
                    pageSize,
                    page,
                    minimumSeverity,
                    maximumSeverity,
                    servers: Alpine.store('log').servers
                }
            };
            let response = await fetch('/search', data);
            let json = await response.json();
            Alpine.store('log').messages = json.data;
        }

        var charts = {};

        document.addEventListener("DOMContentLoaded", function () {
            setInterval(() => {
                syncCharts();
            }, 2500);
        });

        function syncCharts() {
            try {
                Array.prototype.forEach.call(document.getElementsByClassName('metric-canvas'), (element => {
                    let name = element.id
                    makeOrUpdateChart(metricsCompiled[name], name, metricsCompiledLabels[name], element);
                }));
            } catch (err) {
                console.log(err);
            }
        }

        function makeOrUpdateChart(chartData, chartName, chartLabels, element) {
            if (charts[chartName] == undefined) {
                console.log('Creating chart ' + chartName);
                let context = element.getContext('2d');
                let myChart = new Chart(context, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: chartName,
                            data: chartData,
                            fill: true,
                            backgroundColor: '#07429b',
                            borderColor: '#002468',
                            tension: 0.1
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                labels: {
                                    color: "white"
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    color: "white"
                                },
                                grid: {
                                    color: '#888'
                                }
                            },
                            x: {
                                ticks: {
                                    color: "white"
                                },
                                grid: {
                                    color: '#888'
                                }
                            }
                        }
                    }
                });
                charts[chartName] = myChart;
            } else {
                console.log('Updating chart ' + chartName);
                charts[chartName].data.datasets[0].data = chartData;
                charts[chartName].data.labels = chartLabels;
                charts[chartName].update();
            }
        }
    </script>
</body>

</html>