<html>

<head>
    <script defer src="/alpine.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/translation.js"></script>
    <link rel="stylesheet" href="/bootstrap.css">
    <link rel="stylesheet" href="/style.css">
    </link>
</head>

<body x-data class="body-base">
    <div class="modal-overlay" x-show="$store.controls.showModal"></div>
    <div class="modalx bd-example" x-show="$store.controls.showModal">

        <p class="mt-2">Password: </p>
        <input class="form-control" type="text" x-model="$store.credentials.password"
            @keydown.enter="$store.controls.showModal = false; authenticate();">
        <div class=" mt-4">
            <button class="btn btn-primary" @click=" $store.controls.showModal=false; authenticate();">Close</button>
        </div>
    </div>
    <div class="col-md-11 mt-3" style="margin: auto; "><a class="title-x" style="color: #0d5dd6;">Socket</a><a
            class="title-x">Logger</a>
        <div class="bd-example row col-md-12 mt-4" style="margin: auto;">
            <div class="row mt-2">
                <div class="col-md-12">
                    <button class="alert btn btn-primary float-start"
                        x-on:click="$store.controls.showModal = true;">Authenticate
                    </button>

                    <button class="alert btn btn-primary float-end"
                        x-on:click="$store.controls.showServerHealth ^= true"
                        x-text="$store.controls.showServerHealth ? 'Switch to messages' : 'Switch to metrics'">
                    </button>
                    <div class="alert alert-danger ms-4 float-start" x-show="$store.credentials.authenticated == 1">
                        Supplied
                        credentials seem to be incorrect.
                    </div>
                    <div class="alert alert-dark ms-4 alm float-start" x-show="$store.credentials.authenticated == 2">
                        Authenticated successfully.</div>
                </div>
            </div>
            <div class=" row mt-2">
                <div class="col-md-3">
                    <p>Search Term:</p>
                    <input class="form-control" type="text" x-model="$store.controls.searchTerm">
                    <button class="btn btn-primary form-control mt-2"
                        x-bind:disabled="!!$store.controls.autoUpdate">Search</button>
                </div>
                <div class="col-md-3">
                    <p x-text="translate('update_speed')"></p>
                    <select class="form-control mt-2">
                        <template x-for="val in [2,3,5,10,15,30,60]">
                            <option x-text="val + translate('seconds')" :value="val"></option>
                        </template>
                    </select>
                    <button class="btn btn-primary form-control mt-2" x-on:click="$store.controls.autoUpdate ^= true"
                        x-text="$store.controls.autoUpdate ? translate('auto_update_active') : translate('auto_update_deactivated')"></button>
                </div>
                <div class="col-md-3">
                    <p>Timeframe-Type:</p>
                    <select x-model="$store.controls.timeframeType" class="form-control mt-2">
                        <option value="0" selected>Messages since</option>
                        <option value="1">Messages within Timeframe</option>
                    </select>
                    <div x-show="$store.controls.timeframeType == 0">
                        <select class="form-control mt-2" x-model="$store.controls.timeSelect">
                            <template x-for="val in [5,10,15,30,60]">
                                <option x-text="val + translate('minutes')" :value="val"></option>
                            </template>
                            <template x-for="val in [2,4,8,24,48]">
                                <option x-text="val + translate('hours')" :value="val*60"></option>
                            </template>
                            <option x-text="translate('all_time')" value="999999"></option>
                        </select>
                    </div>
                    <div x-show="$store.controls.timeframeType == 1">
                        <input class="form-control mt-1" type="datetime-local" x-model="$store.controls.datetime1">
                        <input class="form-control mt-1" type="datetime-local" x-model="$store.controls.datetime2">
                    </div>
                </div>
                <div class="col-md-3">
                    <p>Filter by Server:</p>
                    <select class="form-control mt-2" multiple>
                        <template x-for="server in $store.log.servers">
                            <option x-bind:value="server" x-text="server"></option>
                        </template>
                    </select>
                </div>
            </div>
        </div>
        <div class="bd-example row col-md-12 mt-4" style="margin: auto; font-size: 15px; font-family: monospace;"
            x-show="$store.controls.showServerHealth">
            <template x-for="server in $store.log.servers">
                <div class="bd-example col-md-12 mt-2">
                    <div x-text="server.name" style="text-align: center;"></div>
                    <template x-for="metric in $store.controls.metrics">
                        <div style="padding: 5px;" class="col-md-3 float-start">
                            <canvas class="metric-canvas" :id="server.name + ': ' + metric"></canvas>
                        </div>
                    </template>
                </div>
            </template>
        </div>
        <div class="bd-example row col-md-12 mt-4" style="margin: auto; font-size: 15px; font-family: monospace;"
            x-show="!$store.controls.showServerHealth">
            <div class="btn btn-primary alx">
                &lt;
            </div>
            <div class="btn btn-primary alx">
                1
            </div>
            <div class="btn btn-primary alx">
                ...
            </div>
            <div class="btn btn-primary alx">
                12
            </div>
            <div class="btn btn-primary alx">
                ...
            </div>
            <div class="btn btn-primary alx">
                23
            </div>
            <div class="btn btn-primary alx">
                &gt;
            </div>
            <div class="alert alert-dark alm">
                <b>Datetime:</b> 2021-08-01 00:00:00.333<br>
                <b>Message:</b> Example Message Example Message<br>
                <b>Level:</b> Info<br>
                <b>Server:</b> Server 4<br>
                <b>Data:</b><br> Example Message Example Message<br>
            </div>
            <div class="alert alert-danger">
                <b>Datetime:</b> 2021-08-01 00:00:00.333<br>
                <b>Message:</b> Example Message Example Message<br>
                <b>Level:</b> Critical<br>
                <b>Server:</b> Server 4<br>
                <b>Data:</b><br> Example Message Example Message<br>
            </div>
        </div>
    </div>
    <script>
        let basicPost = () => {
            return {
                method: 'POST',
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                headers: {
                    'auth-token': Alpine.store('credentials').password
                }
            };
        }

        async function authenticate() {
            let response = await fetch('/auth', basicPost());
            Alpine.store('credentials').authenticated = await response.text() === 'Authenticated' ? 2 : 1;
        }

        async function updateServerList() {
            if (Alpine.store('credentials').authenticated === 2) {
                try {
                    let response = await fetch('/servers', basicPost());
                    let json = await response.json();
                    Alpine.store('log').servers = json.data;
                } catch (err) {
                    console.log(err)
                }
            }
        }

        setInterval(updateServerList, 1000);
    </script>
    <script>document.addEventListener('alpine:init', () => {

            Alpine.store('log', {
                servers: [],
                messages: [],
                health: []
            })

            Alpine.store('controls', {
                datetime1: new Date().toISOString().split('.')[0],
                datetime2: new Date().toISOString().split('.')[0],
                timeSelect: '2',
                showModal: true,
                showServerHealth: false,
                autoUpdate: false,
                metrics: ['errors', 'warnings', 'cpu', 'ram', 'disk_usage', 'disk_load', 'traffic'],
                timeframeType: 1,
                currentPage: 0,
                searchTerm: '',
            })

            Alpine.store('credentials', {
                password: '',
                authenticated: 0
            })

            this.translate = initializeTranslation(Alpine);
        });

        function registerCanvas(id) {

        }

        function search(searchTerm, minimumSeverity, maximumSeverity, page, pageSize) {

        }

        function updateHealth() {

        }

        var charts = {};
        var xlabels = {};
        var xdata = {};

        document.addEventListener("DOMContentLoaded", function () {
            let elements = document.getElementsByClassName('metric-canvas');
            Array.prototype.forEach.call(elements, (element => {
                registerCanvas(element.id);
            }));

            for (const [name, chart] of Object.entries(charts)) {
                xlabels[name] = Array.from({ length: 12 }, () => Math.floor(Math.random() * 100));
                xdata[name] = Array.from({ length: 12 }, () => Math.floor(Math.random() * 100));

                makeOrUpdateChart(xdata[name], name, xlabels[name]);
            }

            setInterval(() => {
                for (const [name, chart] of Object.entries(charts)) {
                    xlabels[name].pop();
                    xlabels[name].unshift(Math.floor(Math.random() * 20 + xlabels[name][0] * 0.8));

                    xdata[name].pop();
                    xdata[name].unshift(Math.floor(Math.random() * 20 + xdata[name][0] * 0.8));

                    makeOrUpdateChart(xdata[name], name, xlabels[name]);
                }
            }, 2000);
        });

        function makeOrUpdateChart(chartData, chartName, chartLabels) {
            if (charts[chartName] == undefined) {
                console.log('Creating chart ' + chartName);
                let context = document.getElementById(chartName).getContext('2d');
                let myChart = new Chart(context, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: chartName,
                            data: chartData,
                            fill: true,
                            backgroundColor: '#07429b',
                            borderColor: '#002468',
                            tension: 0.1
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                labels: {
                                    color: "white"
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    color: "white"
                                },
                                grid: {
                                    color: '#888'
                                }
                            },
                            x: {
                                ticks: {
                                    color: "white"
                                },
                                grid: {
                                    color: '#888'
                                }
                            }
                        }
                    }
                });
                charts[chartName] = myChart;
            } else {
                console.log('Updating chart ' + chartName);
                charts[chartName].data.datasets[0].data = chartData;
                charts[chartName].data.labels = chartLabels;
                charts[chartName].update();
            }
        }
    </script>
</body>

</html>